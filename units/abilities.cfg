#       *   T R A I T S   *

#define ABILITY_SPAWN_SWARM
[dummy]
    name= _ "Spawn swarm"
    description= "Spawn basic tyranid unit to grow the swarm !
(work in village)"
    id=spawn_swarm
[/dummy]# wmlxgettext: [abilities]
[/abilities]
[event]
    first_time_only=no
    name=side turn
    id=spawnswarm
    [store_unit]
        [filter] # filtre la capacite et le village
            ability=spawn_swarm
            side=$side_number
            [filter_location]
                terrain=*^V*
            [/filter_location]
        [/filter]
        variable=spawner
    [/store_unit]
    {FOREACH spawner i}
        [random_placement]
            num_items=1
            min_distance=0
            allow_less=yes
            variable=spawn_location

            [filter_location]
                [filter_adjacent_location]
                    x,y=$spawner[$i].x,$spawner[$i].y
                [/filter_adjacent_location]
            [/filter_location]

            [command]
                {GENERIC_UNIT $side_number tyranid_egg $spawn_location.x $spawn_location.y}
            [/command]
        [/random_placement]
    {NEXT i}
    {CLEAR_VARIABLE spawner}
[/event]

[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_SPAWN_SPORE
[dummy]
    name= _ "Spawn spore"
    description= "Spawn spore unit to grow the swarm !
(work in fungus) "
    id=spawn_swarm
[/dummy]# wmlxgettext: [abilities]
[/abilities]
[event]
    first_time_only=no
    name=side turn
    id=spawnswarm
    [store_unit]
        [filter] # filtre la capacite et le village
            ability=spawn_swarm
            side=$side_number
            [filter_location]
                terrain=*T*
            [/filter_location]
        [/filter]
        variable=spawner
    [/store_unit]
    {FOREACH spawner i}
        [random_placement]
            num_items=1
            min_distance=0
            allow_less=yes
            variable=spawn_location

            [filter_location]
                [filter_adjacent_location]
                    x,y=$spawner[$i].x,$spawner[$i].y
                [/filter_adjacent_location]
            [/filter_location]

            [command]
                {GENERIC_UNIT $side_number fungus $spawn_location.x $spawn_location.y}
            [/command]
        [/random_placement]
    {NEXT i}
    {CLEAR_VARIABLE spawner}
[/event]

[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_REPAIR_8
    [heals]
        value=8
        id=repair
        affect_allies=yes
        name= _ "repairs 8"
        description= _ "Allows the unit to repair adjacent friendly mechanical units at the beginning of each turn. A unit cared for by this healer may heal up to 8HP per turn."
        affect_self=no
        poison=cured
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                race=vehicule,vehicule_chaos
            [/filter]
        [/affect_adjacent]
    [/heals]
#enddef

#define WEAPON_SPECIAL_EEAWKAMIKAZE
    [damage]
        id=eeawkamikaze
        name= _ "kamikaze"
        description="This unit dies instantly after performing a successful attack."
    [/damage]
#enddef

#define KAMIKAZE_ACTION
[event]
    name=attacker hits
    first_time_only=no
    [filter]
        x,y=$x1,$y1
        has_weapon=eeawkamikaze
    [/filter]
    [kill]
        x,y=$x1,$y1
        animate=no
    [/kill]
	[if]
	{VARIABLE_CONDITIONAL second_unit.hitpoints less_than_equal_to 0}
	[then]
		[kill]
			x,y=$x2,$y2
			animate=yes
		[/kill]
	[/then]
	[/if]
[/event]

[event]
    name=defender hits
    first_time_only=no
    [filter_second]
        x,y=$x2,$y2
        has_weapon=eeawkamikaze
    [/filter_second]
    [kill]
        x,y=$x2,$y2
        animate=no
    [/kill]
	[if]
	{VARIABLE_CONDITIONAL unit.hitpoints less_than_equal_to 0}
	[then]
		[kill]
			x,y=$x1,$y1
			animate=yes
		[/kill]
	[/then]
	[/if]
[/event]
#enddef

#define ABILITY_SHADOW_WARP
    [resistance]
        id=shadow_warp
        add=15
        max_value=50
        apply_to=arcane
        name= _ "Shadow in the Warp"
        description= _ "Adjacent units of this side receive a +15% bonus to psychic (up to a maximum of 50%)."
        affect_self=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/resistance]
#enddef

#define ABILITY_BLOODLUST
    [dummy]
        id=bloodlust
        name= _ "bloodlust"
        description=_"This unit can attack another unit after killing an enemy."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=die
    id=bloodlust_event
    first_time_only=no
    [filter_second]
        side=$side_number
        ability=bloodlust
    [/filter_second]

    {VARIABLE_OP second_unit.attacks_left add 1}
    [unstore_unit]
        variable=second_unit
        {COLOR_HARM}
        text= _ "BLOODLUST!"
        find_vacant=no
    [/unstore_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef


#define ABILITY_FEAR10
    [leadership]
        id=fear10
        value=-10
        cumulative=no
        name= _ "fear"
        description="Fear makes all enemy units fight worse (-10% damage)."
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/leadership]
#enddef

#define ABILITY_FEAR15
    [leadership]
        id=fear15
        value=-15
        cumulative=no
        name= _ "fear"
        description="Fear makes all enemy units fight worse (-15% damage)."
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/leadership]
#enddef

#define ABILITY_FEAR25
    [leadership]
        id=fear25
        value=-25
        cumulative=no
        name= _ "fear"
        description="Fear makes all enemy units fight worse (-25% damage)."
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/leadership]
#enddef

#define ABILITY_FEAR35
    [leadership]
        id=fear35
        value=-35
        cumulative=no
        name= _ "fear"
        description="Fear makes all enemy units fight worse (-35% damage)."
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/leadership]
#enddef

#define ABILITY_DARKNESS_AURA
[dummy]
    name= _ "Darkness Aura"
    description= "Random aura, may the gods of chaos be with you"
    id=darkness_aura
[/dummy]# wmlxgettext: [abilities]
[/abilities]
	[event]
		name=turn end
		first_time_only=no
		
		[store_unit]
			[filter]
				ability=darkness_aura
			[/filter]
			variable=darkness_list
		[/store_unit]
		
		{FOREACH darkness_list i}
			{CLEAR_VARIABLE darkness_list[$i].abilities.skirmisher}
            {CLEAR_VARIABLE darkness_list[$i].abilities.penumbra}
            {CLEAR_VARIABLE darkness_list[$i].abilities.big_protection}
            {CLEAR_VARIABLE darkness_list[$i].abilities.rally}
			[unstore_unit]
				variable=darkness_list[$i]
			[/unstore_unit]
		{NEXT i}
		
		{FOREACH darkness_list i}
			[set_variable]
				name=roll
				rand=1..4
			[/set_variable]
			[if]
				[variable]
					name=roll
                    equals=1
                [/variable]
				[then]
					{VARIABLE darkness_list[$i].abilities.skirmisher.id skirmisher}
                    {VARIABLE darkness_list[$i].abilities.skirmisher.name "skirmisher"}
					{VARIABLE darkness_list[$i].abilities.skirmisher.description  "Skirmisher:
This unit is skilled in moving past enemies quickly, and ignores all enemy Zones of Control."}
					[unstore_unit]
						variable=darkness_list[$i]
					[/unstore_unit]
				[/then]
			[/if]
    
			[if]
				[variable]
					name=roll
                    equals=2
                [/variable]
                [then]
					{VARIABLE darkness_list[$i].abilities.penumbra.id penumbra}
                    {VARIABLE darkness_list[$i].abilities.penumbra.name "penumbra"}
                    {VARIABLE darkness_list[$i].abilities.penumbra.description  "Penumbra:
                    This unit darkens the surrounding area, making chaotic units fight better, and lawful units fight worse.

                    Any units adjacent to this unit will fight as if it were night."}
					[unstore_unit]
						variable=darkness_list[$i]
					[/unstore_unit]
                [/then]
            [/if]

			[if]
				[variable]
					name=roll
                    equals=3
                [/variable]
                [then]
					{VARIABLE darkness_list[$i].abilities.big_protection.id big_protection}
                    {VARIABLE darkness_list[$i].abilities.big_protection.name "protection"}
                    {VARIABLE darkness_list[$i].abilities.big_protection.description  "Adjacent units of this side receive a +15% bonus to all resistances (up to a maximum of 60%)."}
					[unstore_unit]
						variable=darkness_list[$i]
					[/unstore_unit]
                [/then]
            [/if]

			[if]
				[variable]
					name=roll
                    equals=4
                [/variable]
                [then]
					{VARIABLE darkness_list[$i].abilities.rally.id rally}
                    {VARIABLE darkness_list[$i].abilities.rally.name "rally"}
                    {VARIABLE darkness_list[$i].abilities.rally.description  "After making an attack, this unit can rally friendly units that are next to it, making them fight (15% times this unit's level) better, regardless of their level.

                    This effect stacks on top of other leadership abilities."}
					[unstore_unit]
						variable=darkness_list[$i]
					[/unstore_unit]
                [/then]
            [/if]


		{NEXT i}
	[/event]
[+abilities]
#enddef



#define ABILITY_PENUMBRA
    [illuminates]
        id=penumbra
        value=-50
        min_value=-25
        max_value=25
        cumulative=no
        affect_self=yes
        name= _ "penumbra"
        female_name= _ "female^penumbra"
        description= _ "Penumbra:
This unit darkens the surrounding area, making chaotic units fight better, and lawful units fight worse.

Any units adjacent to this unit will fight as if it were night."
    [/illuminates]
#enddef

#define WEAPON_SPECIAL_C1
    [chance_to_hit]
        id=WEAPON_SPECIAL_C1
        name= _ "C1"
        name_inactive= _ "spinning"
        description=_"This weapon has a -20% chance to hit."
        apply_to=self
        add=-20
        max_value=75
    [/chance_to_hit]
#enddef
#define WEAPON_SPECIAL_C2
    [chance_to_hit]
        id=WEAPON_SPECIAL_C2
        name= _ "C2"
        name_inactive= _ "spinning"
        description=_"This weapon has a -10% chance to hit."
        apply_to=self
        add=-10
        max_value=75
    [/chance_to_hit]
#enddef
#define WEAPON_SPECIAL_C3
    [chance_to_hit]
        id=WEAPON_SPECIAL_C3
        name= _ "C3"
        name_inactive= _ "spinning"
        description=_"This weapon has a +5% chance to hit."
        apply_to=self
        add=5
	max_value=75
    [/chance_to_hit]
#enddef
#define WEAPON_SPECIAL_C4
    [chance_to_hit]
        id=WEAPON_SPECIAL_C4
        name= _ "C4"
        name_inactive= _ "spinning"
        description=_"This weapon has a +10% chance to hit."
        apply_to=self
        add=10
	max_value=75
    [/chance_to_hit]
#enddef
#define WEAPON_SPECIAL_C5
    [chance_to_hit]
        id=WEAPON_SPECIAL_C5
        name= _ "C5"
        name_inactive= _ "spinning"
        description=_"This weapon has a +20% chance to hit."
        apply_to=self
        add=20
	max_value=75
    [/chance_to_hit]
#enddef
#define WEAPON_SPECIAL_C6
    [chance_to_hit]
        id=WEAPON_SPECIAL_C6
        name= _ "C6"
        name_inactive= _ "spinning"
        description=_"This weapon has a +30% chance to hit."
        apply_to=self
        add=30
	max_value=75
    [/chance_to_hit]
#enddef


#define WEAPON_SPECIAL_AE_MAG_ANTISHIELD
    [dummy]
        id=AE_mag_antishield
        name= _ "anti-shield"
        description=_"This attack negates all possible resistances, thus the damage output is always constant."
    [/dummy]
#enddef

#define ABILITY_AE_MAG_HARDLANDING DMG TYPE
    [dummy]
        id=AE_mag_hardlanding{DMG}{TYPE}
        name= _ "hard landing"+" ({DMG})"
        description=_"When this large unit is destroyed, it falls on a ground dealing damage to all adjacent units. "
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
#enddef

#define AE_ELE_WEAPON_SPECIAL_RESISTANT VALUE
    [damage]
        id=AE_ele_resistant{VALUE}
        name= _ "resistant {VALUE}"
        name_inactive= _ "resistant {VALUE}"
        description= _ "When this attack is used offensively, this unit takes {VALUE} damage less on every strike."
        description_inactive= _ "When this attack is used offensively, this unit takes {VALUE} damage less on every strike."
        active_on=offense
        apply_to=opponent
        add=-{VALUE}
    [/damage]
#enddef


#define WEAPON_SPECIAL_INTERRUPT
    [dummy]
        id=interrupt
        name= _ "interrupt"
        description=_"
When a unit is hit with an interrupting attack, combat is immediately stopped. Inactive in rpg."
    [/dummy] # wmlxgettext: [specials]
[/specials] # wmlxgettext: [attack]
[/attack]
[event]
    name=attacker_hits
    first_time_only=no
    id=interrupt_attack

    [filter_attack]
        special=interrupt
    [/filter_attack]
    [filter_condition]
        [variable]
            name=unit.hitpoints
            greater_than=0
        [/variable]
        [variable]
            name=second_unit.hitpoints
            greater_than=0
        [/variable]
    [/filter_condition]

    [store_unit]
        [filter]
            find_in=unit
        [/filter]
        variable=target
        kill=yes
    [/store_unit]
    {VARIABLE target.variables.interrupt yes}
[/event]
[event]
    name=defender hits
    first_time_only=no
    id=interrupt_defend

    [filter_second_attack]
        special=interrupt
    [/filter_second_attack]
    [filter_condition]
        [variable]
            name=unit.hitpoints
            greater_than=0
        [/variable]
        [variable]
            name=second_unit.hitpoints
            greater_than=0
        [/variable]
    [/filter_condition]
    [store_unit]
        [filter]
            find_in=second_unit
        [/filter]
        variable=target
        kill=yes
    [/store_unit]
    {VARIABLE target.variables.interrupt yes}
[/event]
[event]
    name=attack end
    first_time_only=no
    id=interrupt_unstore
    [filter_condition]
        [variable]
            name=target.variables.interrupt
            equals=yes
        [/variable]
    [/filter_condition]
    {CLEAR_VARIABLE target.variables.interrupt}
    [unstore_unit]
        variable=target
        text=_ "interrupt"
        {COLOR_HEAL}
    [/unstore_unit]
    {CLEAR_VARIABLE target}
[/event]
[+attack]
    [+specials]
        # wmlxgettext: [/specials]
        # wmlxgettext: [/attack]
#enddef


#define AURA_BLITZ
[dummy]
	id=blitz	
	name= _ "blitz"
	description= _ "Blitz:
Kroots that start their turn adjacent to this unit are granted Skirmisher for that turn."
[/dummy]
[/abilities]
	[event]
		name=side turn
		first_time_only=no
		
		[store_unit]
			[filter]
				
				[wml_filter]
					blitzed=1
				[/wml_filter]
			[/filter]
			variable=blitz_refresh
		[/store_unit]
		
		{FOREACH blitz_refresh i}
			{CLEAR_VARIABLE blitz_refresh[$i].abilities.skirmisher}
			{VARIABLE blitz_refresh[$i].blitzed 0}
			[unstore_unit]
				variable=blitz_refresh[$i]
			[/unstore_unit]
		{NEXT i}

		[store_unit]
			[filter]
				side=$side_number
                race=kroot
				[filter_adjacent]
					is_enemy=no
				[/filter_adjacent]
			[/filter]
			variable=blitzed
		[/store_unit]
		
		{FOREACH blitzed i}
			[if]
				[variable]
					name=blitzed[$i].abilities.skirmisher.id
					not_equals="skirmisher"
				[/variable]
				[then]
					{VARIABLE blitzed[$i].blitzed 1}
					{VARIABLE blitzed[$i].abilities.skirmisher.id skirmisher}
					{VARIABLE blitzed[$i].abilities.skirmisher.name "skirmisher"}
					{VARIABLE blitzed[$i].abilities.skirmisher.description  "Skirmisher:
This unit is skilled in moving past enemies quickly, and ignores all enemy Zones of Control."}
					[unstore_unit]
						variable=blitzed[$i]
					[/unstore_unit]
				[/then]
			[/if]
		{NEXT i}
	[/event]
[+abilities]
#enddef

#define ABILITY_SELF_LEARNING

[dummy]
    name= _ "Self learning"
    description= "This unit gain 1 XP per turn"
    id=self_learning
[/dummy]# wmlxgettext: [abilities]
[/abilities]
[event]
    first_time_only=no
    name=side turn
    id=selflearning
    [store_unit]
        [filter]
            ability=self_learning
            side=$side_number
        [/filter]
        variable=self_learner
    [/store_unit]
    {FOREACH self_learner i}
        [set_variable]
            name=self_learner[$i].experience
            add=1
        [/set_variable]
        [unstore_unit]
            variable=self_learner[$i]
            find_vacant=no
        [/unstore_unit]
    {NEXT i}
    {CLEAR_VARIABLE self_learner}
[/event]

[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_EEAW_CAVALRYLINE
    [dummy]
        id=eeawcavline
        name= _ "cavalry line"
        description=_"When this unit stands near a unit with the same ability, both receive +1 to damage."
    [/dummy]
#enddef

#define WEAPON_SPECIAL_EEAW_CAVALRYLINE
    [damage]
        id=eeawcavline2
        #name= _ " "
        #description=_"."
        add=1
		apply_to=self
		[filter_self]
			[filter_adjacent]
				ability=eeawcavline
				is_enemy=false
			[/filter_adjacent]
		[/filter_self]
    [/damage]
#enddef

#define ABILITY_EEAW_FLANKING
    [dummy]
        id=eeawflanking
        name= _ "flanking"
        description=_"When this unit attacks an enemy who is enganed in combat with other friendly unit, this unit has a higher chance to hit (+10%)."
    [/dummy]
#enddef

#define WEAPON_SPECIAL_EEAW_FLANKING
    [chance_to_hit]
        id=eeawflanking2
        add=10
        apply_to=self
		cumulative=yes
        #name= _ " "
        #description=_"."
        [filter_opponent]
			[filter_adjacent]
				ability=eeawflanking
				count=2-6
				is_enemy=true
			[/filter_adjacent]
		[/filter_opponent]
    [/chance_to_hit]
#enddef

#define ABILITY_EEAW_FORTIFY
	#this automatically applies fortify special to units
    [dummy]
        id=eeawfortify
        name= _ "fortify"
        description=_"if this unit stands still for one turn it will receive a 20% cover bonus on a non-water terrain in the next turn. If the unit is hiding in a castle or keep it will receive +10% bonus."
		[filter]
			[not]
				[filter_location]
					terrain=W*
				[/filter_location]
			[/not]
		[/filter]
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
	
	[event]
        name=side turn
        first_time_only=no
		id=eeaw_fortify_masterevent
	
		[store_unit]
			variable=sapper
			[filter]
				ability=eeawfortify
				side=$side_number
				[not]
					[filter_location]
						terrain=W*
					[/filter_location]
				[/not]
			[/filter]
		[/store_unit]
		{FOREACH sapper i}
			#evaluate
			{VARIABLE sapper[$i].variables.new_x $sapper[$i].x}
			{VARIABLE sapper[$i].variables.new_y $sapper[$i].y}
			
			[if]
			{VARIABLE_CONDITIONAL sapper[$i].variables.new_x equals $sapper[$i].variables.old_x}
			[and]
			{VARIABLE_CONDITIONAL sapper[$i].variables.new_y equals $sapper[$i].variables.old_y}
			[/and]
			[then]
				{VARIABLE sapper[$i].variables.fortified 1}
				{VARIABLE sapper[$i].variables.old_x $sapper[$i].variables.new_x}
				{VARIABLE sapper[$i].variables.old_y $sapper[$i].variables.new_y}
				[unstore_unit]
					variable=sapper[$i]
					#text="FORTIFIED"
					#{COLOR_HEAL}
				[/unstore_unit]
			[/then]
			[else]
				{VARIABLE sapper[$i].variables.fortified 0}
				{VARIABLE sapper[$i].variables.old_x $sapper[$i].variables.new_x}
				{VARIABLE sapper[$i].variables.old_y $sapper[$i].variables.new_y}
				[unstore_unit]
					variable=sapper[$i]
				[/unstore_unit]
			[/else]
			[/if]
		{NEXT i}
		{CLEAR_VARIABLE sapper}
	[/event]
	
	#end turn hack movement for special's conditional to pass
	[event]
        name=side turn end
        first_time_only=no
		id=eeaw_fortify_masterevent2
	
		[store_unit]
			variable=sapper
			[filter]
				ability=eeawfortify
				side=$side_number
				[filter_wml]
					attacks_left=0
				[/filter_wml]
				[not]
					[filter_location]
						terrain=W*
					[/filter_location]
				[/not]
			[/filter]
		[/store_unit]
		{FOREACH sapper i}
			{VARIABLE sapper[$i].moves $sapper[$i].max_moves}
			[unstore_unit]
				variable=sapper[$i]
			[/unstore_unit]
		{NEXT i}
		{CLEAR_VARIABLE sapper}
	[/event]
	
	#check attack position
	[event]
		name=attack
		first_time_only=no
		id=eeaw_fortify_attackevent
		
		[filter]
			ability=eeawfortify
		[/filter]
		
		{VARIABLE unit.variables.new_x $x1}
		{VARIABLE unit.variables.new_y $y1}
		
		[if]
		{VARIABLE_CONDITIONAL unit.variables.new_x equals $unit.variables.old_x}
		[and]
		{VARIABLE_CONDITIONAL unit.variables.new_y equals $unit.variables.old_y}
		[/and]
		[else]
			{VARIABLE unit.variables.fortified 0}
			[unstore_unit]
				variable=unit
			[/unstore_unit]
		[/else]
		[/if]
	[/event]
	
	#set initial parameters upon recruit
	[event]
		name=recruit
		first_time_only=no
		id=eeaw_fortify_recruitevent
		
		[filter]
			ability=eeawfortify
		[/filter]
		
		{MODIFY_UNIT id=$unit.id variables.new_x $x1}
		{MODIFY_UNIT id=$unit.id variables.new_y $y1}
		{MODIFY_UNIT id=$unit.id variables.old_x $x1}
		{MODIFY_UNIT id=$unit.id variables.old_y $y1}
		
		[modify_unit]
			[filter]
				x,y=$x1,$y1
			[/filter]
			[object]
				[filter]
					x,y=$x1,$y1
				[/filter]
				[effect]
					apply_to=attack
					[set_specials]
						mode=append
						{WEAPON_SPECIAL_EEAW_FORTIFY}
					[/set_specials]
				[/effect]
			[/object]
		[/modify_unit]
	[/event]
		
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define WEAPON_SPECIAL_EEAW_FORTIFY
    [chance_to_hit]
        id=eeawfortify2
        add=-20
        apply_to=opponent
		cumulative=yes
        #name= _ "fortify"
        #description=_"."
        [filter_self]
			[filter_wml]
				moves=$this_unit.max_moves
			[/filter_wml]
			[and]
				[filter_wml]
					[variables]
						fortified=1
					[/variables]
				[/filter_wml]
			[/and]
			[not]
				[filter_location]
					terrain=W*,K*,C*
				[/filter_location]
			[/not]
		[/filter_self]
    [/chance_to_hit]
	[chance_to_hit]
        id=eeawfortify3
        add=-10
        apply_to=opponent
		cumulative=yes
        #name= _ "fortify"
        #description=_"."
        [filter_self]
			[filter_wml]
				moves=$this_unit.max_moves
			[/filter_wml]
			[and]
				[filter_wml]
					[variables]
						fortified=1
					[/variables]
				[/filter_wml]
			[/and]
			[and]
				[filter_location]
					terrain=K*,C*
				[/filter_location]
			[/and]
		[/filter_self]
    [/chance_to_hit]
#enddef

#define WEAPON_SPECIAL_EEAW_EXCAVATION
    [chance_to_hit]
        id=eeawexcavation
        value=0
        apply_to=self
		cumulative=no
        name= _ "fortify first"
        description=_"This attack is possible only if the unit does not move to other places (fortifies himself)."
        [filter_self]
			[filter_wml]
				[not]
					moves=$this_unit.max_moves
				[/not]
			[/filter_wml]
		[/filter_self]
    [/chance_to_hit]
	[chance_to_hit]
        id=eeawexcavation
        value=0
        apply_to=self
		cumulative=no
        [filter_opponent]
			race=eeawship
		[/filter_opponent]
    [/chance_to_hit]
	[attacks]
        id=eeawexcavation
        value=0
        apply_to=self
		cumulative=no
        [filter_self]
			[filter_wml]
				[not]
					moves=$this_unit.max_moves
				[/not]
			[/filter_wml]
		[/filter_self]
    [/attacks]
	[attacks]
        id=eeawexcavation
        value=0
        apply_to=self
		cumulative=no
        [filter_opponent]
			race=eeawship
		[/filter_opponent]
    [/attacks]
	[attacks]
        id=nocounter2
        name= _ "no counter-attack"
        description= _ "The opponent has always a 0% chance to hit, when this unit is attacking."
        name_inactive= _ "no counter-attack"
        description_inactive= _ "The opponent has always a 0% chance to hit, when this unit is attacking."
        value=0
        cumulative=no
        active_on=offense
        apply_to=opponent
    [/attacks]
	
	[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring

	[event]
		name=attack end
		id=eeaw_excavation_event1
		first_time_only=no
		
		[filter]
			type=pr Sapper,pr Engineer
		[/filter]
		
		{MODIFY_UNIT id=$unit.id moves 0}
	[/event]
[+attack]
# wmlindent: start ignoring

[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
# wmlindent: stop ignoring
#enddef


#define ABILITY_EEAWCURES4
    [heals]
        value=4
        id=curing4
        affect_allies=yes
        name= _ "cures 4"
        female_name= _ "female^cures 4"
        description=  _ "Allows the unit to heal adjacent allied units and self at the beginning of its turn and cure them from poison."
        affect_self=yes
        poison=cured
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
		[filter]
			[filter_location]
				[not]
					terrain=*^V*,K*,C*
				[/not]
			[/filter_location]
		[/filter]
    [/heals]
#enddef
#define ABILITY_EEAWCURES8
    [heals]
        value=8
        id=curing8
        affect_allies=yes
        name= _ "cures 8"
        female_name= _ "female^cures 8"
        description=  _ "Allows the unit to heal adjacent allied units and self at the beginning of its turn and cure them from poison."
        affect_self=yes
        poison=cured
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
		[filter]
			[filter_location]
				[not]
					terrain=*^V*,K*,C*
				[/not]
			[/filter_location]
		[/filter]
    [/heals]
#enddef
#define ABILITY_REGENERATES
    # Canned definition of the Regenerate ability to be included in an [abilities]
    # clause.
    [regenerate]
        value=8
        id=regenerates
        name= _ "regenerates"
        female_name= _ "female^regenerates"
        description= _ "The unit will heal itself 8 HP per turn. If it is poisoned, it will remove the poison instead of healing."
        affect_self=yes
        poison=cured
    [/regenerate]
#enddef

#define ABILITY_AGGRESSIVE_GUNSHIP_DIPLOMATY
 [dummy]
  name= _ "Agressive Gunship Diplomaty"
        id=eeawcapture
        description= _ "This unit generates 15 gold every time it captures an enemy village."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]

	[event]
		name=capture
        first_time_only=no
        id=aggresivcapture
		
        [filter]
            ability=eeawcapture
		[/filter]
		
		{IF_VAR owner_side equals 0 (
		[then]
		[/then]
		[else]
			[gold]
				amount=10
				side=$unit.side
			[/gold]
			[sound]
				name=gold.ogg
			[/sound]
			[unstore_unit]
				variable=unit
				text="10"
				red,green,blue=255,255,0
				find_vacant=no
			[/unstore_unit]
		[/else]
		)}
	[/event]
	[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_SOFT_GUNSHIP_DIPLOMATY
 [dummy]
  name= _ "Soft Gunship Diplomaty"
        id=eeawcapture_soft
        description= _ "This unit generates 3 gold every time it captures an village."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]

	[event]
		name=capture
		first_time_only=no
        id=softcapture
        
        [filter]
            ability=eeawcapture_soft
		[/filter]
		
			[gold]
				amount=5
				side=$unit.side
			[/gold]
			[sound]
				name=gold.ogg
			[/sound]
			[unstore_unit]
				variable=unit
				text="5"
				red,green,blue=255,255,0
				find_vacant=no
            [/unstore_unit]
	[/event]
	[+abilities] # wmlxgettext: [/abilities]
#enddef


#define ATTACK_SPECIAL_HINDERS
    # definition to be included in a [specials] clause.
    [slow]
        id=hinders
        name= _ "hinders"
        name_inactive= _ "hinders"
        description= _ "This attack hinders the target until it ends a turn. Hindering halves the damage caused by attacks and the movement cost for a slowed unit is doubled. A unit that is hindered will feature a snail icon in its sidebar information when it is selected."
    [/slow]
#enddef


#define ABILITY_MENTOR
    # wmlxgettext: [abilities]
    [dummy]
        id=mentor
        name= _ "mentor"
        description=_"This units ability to teach battle skills gives each adjacent allied unit a +1 to experience earned in battle."
    [/dummy]
[/abilities]
[event]
    name=attack_end
    id=mentor_1
    [filter]
        [filter_adjacent]
            ability=mentor
            is_enemy=false
        [/filter_adjacent]
    [/filter]
    [set_variable]
        name=unit.experience
        add=1
    [/set_variable]
    [unstore_unit]
        variable=unit
        text=_ "1"
        red,green,blue=0,200,255
    [/unstore_unit]
    first_time_only=no
[/event]

[event]
    name=attack_end
    id=id=mentor_2
    [filter_second]
        [filter_adjacent]
            ability=mentor
            is_enemy=false
        [/filter_adjacent]
    [/filter_second]
    [set_variable]
        name=second_unit.experience
        add=1
    [/set_variable]
    [unstore_unit]
        variable=second_unit
        text=_ "1"
        red,green,blue=0,200,255
    [/unstore_unit]
    first_time_only=no
[/event]
[+abilities]
    # wmlxgettext: [/abilities]
#enddef

#define ABILITY_MENTOR2
    # wmlxgettext: [abilities]
    [dummy]
        id=mentor2
        name= _ "mentor2"
        description=_"This units ability to teach battle skills gives each adjacent allied unit a +2 to experience earned in battle."
    [/dummy]
[/abilities]
[event]
    name=attack_end
    id=mentor_12
    [filter]
        [filter_adjacent]
            ability=mentor
            is_enemy=false
        [/filter_adjacent]
    [/filter]
    [set_variable]
        name=unit.experience
        add=2
    [/set_variable]
    [unstore_unit]
        variable=unit
        text=_ "2"
        red,green,blue=0,200,255
    [/unstore_unit]
    first_time_only=no
[/event]

[event]
    name=attack_end
    id=id=mentor_22
    [filter_second]
        [filter_adjacent]
            ability=mentor
            is_enemy=false
        [/filter_adjacent]
    [/filter_second]
    [set_variable]
        name=second_unit.experience
        add=2
    [/set_variable]
    [unstore_unit]
        variable=second_unit
        text=_ "2"
        red,green,blue=0,200,255
    [/unstore_unit]
    first_time_only=no
[/event]
[+abilities]
    # wmlxgettext: [/abilities]
#enddef

#define WEAPON_SPECIAL_PRECISION100
    [chance_to_hit]
        id=precision100
        name= _ "precision100"
        description= "When used offensively, this attack always has at least a 100% chance to hit."
        value=100
        cumulative=yes
        active_on=offense
    [/chance_to_hit]
#enddef
#define WEAPON_SPECIAL_FORMATION
    [resistance]
        id=formation
        name= _ "formation"
        description= _ "Formation:
    When this unit is adjacent to another unit with formation, it increases its resistances to the physical damage types by 10%."
    [/resistance]
    [resistance]
        add=10
        cumulative=yes
        apply_to=blade,pierce,impact,wedge,impale
        affect_self=yes
        [filter_adjacent]
            adjacent=n,s
        ability=formation
        [/filter_adjacent]
    [/resistance]
    [resistance]
        add=10
        cumulative=yes
        apply_to=blade,pierce,impact,wedge,impale
        affect_self=yes
        [filter_adjacent]
            adjacent=ne,sw
        ability=formation
        [/filter_adjacent]
    [/resistance]
    [resistance]
        add=10
        cumulative=yes
        apply_to=blade,pierce,impact,wedge,impale
        affect_self=yes
        [filter_adjacent]
            adjacent=nw,se
        ability=formation
        [/filter_adjacent]
    [/resistance]
#enddef

#define ABILITY_BEHAVIOUR
    [resistance]
        id=InstinctiveBehaviour
        name= _ "Instinctive Behaviour"
        description= _ "Instinctive Behaviour:
	Low hierachy tyranid need to be near synaptic for obtain all their power.
	Gain 1 attack dmg, 10% blade, pierce, impact resistance"
[/resistance]
[resistance]
        add=10
        cumulative=yes
        apply_to=blade,pierce,impact
        affect_self=yes
        [filter_adjacent]
            adjacent=n,s
        ability=synapse
        [/filter_adjacent]
    [/resistance]  
[resistance]
        add=10
        cumulative=yes
        apply_to=blade,pierce,impact
        affect_self=yes
        [filter_adjacent]
            adjacent=ne,sw
        ability=synapse
        [/filter_adjacent]
    [/resistance]  
[resistance]
        add=10
        cumulative=yes
        apply_to=blade,pierce,impact
        affect_self=yes
        [filter_adjacent]
            adjacent=nw,se
        ability=synapse
        [/filter_adjacent]
    [/resistance]   
 [damage]
        id=InstinctiveBehaviour
        name= _ "."
        name_inactive= _ "."
        description= _ "."
        
        affect_self=yes
		[damage]
			add=1
		[/damage]
    [/damage]
#enddef

#define ABILITY_SYNAPSE
    [leadership]
        id=synapse
        value=15
        cumulative=yes
        name= _ "Synaptic Unit 15% leadership"
	female_name= _ "Synaptic Unit"
	name_inactive= _ "Synaptic Unitp"
	female_name_inactive= _ "Synaptic Unit"
        description= _ "Synaptic Unit 
15% leadership + needed for behaviour"

        affect_self=no
        [filter]
            [filter_wml]
                attacks_left=0
            [/filter_wml]
        [/filter]
        [affect_adjacent]
            adjacent=n,s
        [/affect_adjacent]
[affect_adjacent]
            adjacent=ne,sw
        [/affect_adjacent]
[affect_adjacent]
            adjacent=nw,se
        [/affect_adjacent]
    [/leadership]
#enddef
#define ABILITY_VALOR
    [illuminates]
        id=valor
        value=25
        max_value=25
        cumulative=no
        name= _ "valor"
        description= _ "valor:
This unit inspires nearby law-abiding units to greater valor, and strikes fear into the hearts of those who fear the Law.

Any units adjacent to this unit will fight as if it were dusk when it is night, and as if it were day when it is dusk."
        affect_self=yes
    [/illuminates]
#enddef

#define ABILITY_HEALS4
    [heals]
        value=4
        id=healing
        affect_allies=yes
        name= _ "heals +4"
        description="Allows the unit to heal adjacent friendly units at the beginning of each turn.

A unit cared for by this healer may heal up to 4 HP per turn."
        affect_self=no
        poison=slowed
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/heals]
#enddef
#define ABILITY_HEALS8_OS
    [heals]
        value=8
        id=healing
        affect_allies=yes
        name= _ "heals +8"
        description="Allows the unit to heal adjacent friendly units at the beginning of each turn.

A unit cared for by this healer may heal up to 8 HP per turn."
        affect_self=yes
        poison=slowed
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/heals]
#enddef
#define WEAPON_SPECIAL_NOCOUNTERATTACK
    [attacks]
        id=nocounter
        name= _ "no counter-attack"
        description= _ "The opponent has always a 0% chance to hit, when this unit is attacking."
        value=0
        cumulative=no
        active_on=offense
        apply_to=opponent
    [/attacks]
#enddef

#define WEAPON_SPECIAL_ENCHANTED
    [chance_to_hit]
        id=enchanted
        name= _ "enchanted"
        description="This attack always has a 60% chance to hit regardless of the defensive ability of the unit being attacked."
        value=60
        cumulative=no
    [/chance_to_hit]
#enddef

#define WEAPON_SPECIAL_PRECISION
    [chance_to_hit]
        id=precision50
        name= _ "precision 50%"
        description= "When used offensively, this attack always has at least a 50% chance to hit."
        value=50
        cumulative=yes
        active_on=offense
    [/chance_to_hit]
#enddef


#define WEAPON_SPECIAL_ATTACK_ONLY
    [damage]
        id=attack_only
        name= _ "attack only"
        name_inactive= _ "attack only"
        description="This weapon will never be used on defence."
        description_inactive= "This weapon will never be used on defence."
        multiply=0
        active_on=defense
    [/damage]
#enddef


#define WEAPON_SPECIAL_DEFEND_ONLY
    [damage]
        id=defend_inly
        name= _ "defend only"
        description= _ "This weapon will only be available for defense."
        multiply=0
        active_on=offense
    [/damage]
#enddef

#define ABILITY_ILLUMINATES
    # Canned definition of the Illuminates ability to be included in an
    # [abilities] clause.
    [illuminates]
        id=illumination
        value=25
        max_value=25
        cumulative=no
        name= _ "illuminates"
        female_name= _ "female^illuminates"
        description= _ "This unit illuminates the surrounding area, making lawful units fight better, and chaotic units fight worse. Any units adjacent to this unit will fight as if it were dusk when it is night, and as if it were day when it is dusk."
        affect_self=yes
    [/illuminates]
#enddef

#define ABILITY_SKIRMISHER
    # Canned definition of the Skirmisher ability to be included in an [abilities]
    # clause.
    [skirmisher]
        id=skirmisher
        name= _ "skirmisher"
        female_name= _ "female^skirmisher"
        description= _ "This unit is skilled in moving past enemies quickly, and ignores all enemy Zones of Control."
        affect_self=yes
    [/skirmisher]
#enddef

#define ABILITY_MOVE1
    [dummy]
        id=move1
        name= _ "hit and run1"
        description=_"This unit gains one additional move back after attacking, but cannot attack again."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=attack_end
    id=hitandrun_event1
    first_time_only=no
    [filter]
        x,y=$x1,$y1
        ability=hitandrun1
    [/filter]
    {VARIABLE_OP unit.moves add 1}
    [unstore_unit]
        variable=unit
        {COLOR_HEAL}
        text="1 movepoints"
        find_vacant=no
    [/unstore_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef


#define WEAPON_SPECIAL_HIT_AND_RUN
    [dummy]
        id=MdE hit and run
        name=_ "hit and run"
        description=_"This attack costs 3 movement points, thus its user can often move after attacking."
        active_on=offense
    [/dummy]
[/specials]
movement_used=3
[+specials]
#enddef

#define TRAIT_CUDDLY
    [trait]
        id=cuddly
        male_name= _ "cuddly"
        female_name= _ "female^cuddly"
        [effect]
            apply_to=attack
            range=melee
            increase_damage=1
        [/effect]
        [effect]
            apply_to=hitpoints
            increase_total=1
        [/effect]
    [/trait]
#enddef
	
#define TRAIT_SOFT
    [trait]
        id=soft
        male_name= _ "soft"
        female_name= _ "female^soft"
        [effect]
            apply_to=movement
            increase=1
        [/effect]
        [effect]
            apply_to=hitpoints
            increase_total=-5%
        [/effect]
    [/trait]
#enddef

#define TRAIT_CUTE
    [trait]
        id=cute
        male_name= _ "cute"
        female_name= _ "female^cute"
        [effect]
            apply_to=max_experience
            increase=-20%
        [/effect]
    [/trait]
#enddef

#define TRAIT_STUFFED
    [trait]
        id=stuffed
        male_name= _ "stuffed"
        female_name= _ "female^stuffed"
        [effect]
            apply_to=hitpoints
            increase_total=4
        [/effect]
        [effect]
            apply_to=hitpoints
            times=per level
            increase_total=1
        [/effect]
    [/trait]
#enddef

#define TRAIT_TOY

	[trait]

		id=toy

		availability=musthave

		male_name= _ "toy"

		female_name= _ "female^toy"

		description= _ "Immune to drain, poison and plague"

		[effect]

			apply_to=status

			add=not_living

		[/effect]

	[/trait]

#enddef

#define TRAIT_TATTERED
    [trait]
        id=tattered
        name= _ "tattered"
        description= _ "Zero upkeep"
        [effect]
            apply_to=loyal
        [/effect]
        [effect]
            apply_to=hitpoints
            increase_total=-5%
        [/effect]
        [effect]
            apply_to=max_experience
            increase=5%
        [/effect]
    [/trait]
#enddef

#define TRAIT_ROOTED
    [trait]
      id=rooted
        name= _ "rooted"
        description= _ "A rooted unit moves slower, but regenerates 3 hp per turn."
        [effect]
            apply_to=movement
		increase=-1
        [/effect]
	  [effect]
		apply_to=new_ability
		[abilities]
		[regenerate]
			id=rootregen
			name= _ ""
			description= _ ""
			affect_self=yes
			value=3
		[/regenerate]
		[/abilities]
	   [/effect]
    [/trait]
#enddef

#define TRAIT_KEEN
	[trait]
		id=goodeye
		name= _ "keen"
		description= _ "This unit has better than average senses, granting them a better chance to hit their target."
	[effect]
		apply_to=new_ability
		[abilities]
		[chance_to_hit]
			id=impovedeyes
			name= _ ""
			description= _ ""
			increase_total=5%
			cumulative=no
		[/chance_to_hit]
		[/abilities]
	[/effect]
[/trait]
#enddef

#define TRAIT_BOOK

	[trait]
		id=book
		availability=musthave
		male_name= _ "book"
		female_name= _ "female^book"
		description= _ "Immune to drain, poison and plague"
		[effect]
			apply_to=status
			add=not_living
		[/effect]
	[/trait]

#enddef

#define TRAIT_AFLUENT
	[trait]
		id=afleunt
		name= _ "afluent"
		description= _ "Filled with more pages this unit is smarter and tougher than normal."
	  [effect]
            apply_to=hitpoints
            increase_total=10%
        [/effect]
        [effect]
            apply_to=max_experience
            increase=-10%
        [/effect]
	[/trait]
#enddef

#define TRAIT_QUALITY
	[trait]
		id=quality
		name= _ "high quality"
		description= _ "The quality of this unit's pages grant it more life."
        [effect]
            apply_to=hitpoints
            increase_total=1
        [/effect]
        [effect]
            apply_to=hitpoints
            times=per level
            increase_total=3
        [/effect]
	[/trait]
#enddef

#define TRAIT_PRESSED
	[trait]
		id=pressed
		name= _ "pressed"
		description= _ "This unit's pages have been pressed making them sharper and more aerodinamic."
        [effect]
            apply_to=attack
            range=melee
            increase_damage=1
        [/effect]
        [effect]
            apply_to=movement
            increase=1
        [/effect]
	  [effect]
            apply_to=hitpoints
            increase_total=-12%
        [/effect]
	[/trait]
#enddef

#define TRAIT_BOUND
	[trait]
		id=bound
		name= _ "bound"
		description= _ "This unit is bound in leather increasing it's resistance to bladed and piercing weapons."
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                blade=-10
                pierce=-10
            [/resistance]
        [/effect]
	[/trait]
#enddef


#define ABILITY_SMALL_PROTECT
    [resistance]
        id=small protection
        add=10
        max_value=60
        apply_to=blade,pierce,impact,fire,cold,arcane
        name= _ "protection"
        description= _ "Adjacent units of this side receive a +10% bonus to all resistances (up to a maximum of 60%)."
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/resistance]
#enddef
#define ABILITY_MED_PROTECT
    [resistance]
        id=med protection
        add=15
        max_value=60
        apply_to=blade,pierce,impact,fire,cold,arcane
        name= _ "protection"
        description= _ "Adjacent units of this side receive a +15% bonus to all resistances (up to a maximum of 60%)."
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/resistance]
#enddef
#define ABILITY_LARGE_PROTECT
    [resistance]
        id=big_protection
        add=20
        max_value=60
        apply_to=blade,pierce,impact,fire,cold,arcane
        name= _ "protection"
        description= _ "Adjacent units of this side receive a +20% bonus to all resistances (up to a maximum of 60%)."
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/resistance]
#enddef



#define ABILITY_WB_BATTLETUTOR
    #wmllint: unbalanced-on
    [regenerate]
        id=battletutor
        value=0
        cumulative=no
        name= _ "battle tutor"
        description= _ "This unit's ability to teach battle skills gives each adjacent allied unit a +1 to experience earned in battle."
    [/regenerate]
[/abilities]
[event]
    name=attack_end

        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
			is_enemy=false
            [/filter]
        [/affect_adjacent]
    [set_variable]
        name=unit.experience
        add=1
    [/set_variable]
    [unstore_unit]
        variable=unit
        text=_ "1"
        red,green,blue=0,200,255
    [/unstore_unit]
    first_time_only=no
    cumulative=no
[/event]

[+abilities]
    #wmllint: unbalanced-off
#enddef

#define ABILITY_MASTER_AURA
    [resistance]
        id=masteraura
        name= _ "Master's Aura"
        description= _ "This unit is so respected and knowledgable that it can instruct friendly units in the ways of combat, increasing their attack and defence."
        add=25
        max_value=60
        apply_to=blade,pierce,impact,fire,cold,arcane
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/resistance]
    [leadership]
        id=masteraura
        value=120
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=masteraura
        value=90
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=masteraura
        value=60
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=2
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=masteraura
        value=30
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=3
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef


#define ABILITY_WB_INSPIRE
    [leadership]
        id=leadership
        value=10
        cumulative=no
        name= _ "inspire"
        description= _ "This unit can inspire friendly units that are next to it, making them fight better.

Adjacent friendly level 1 units will do 10% more damage in battle, and level 0 units will do 25% more."
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
   [/leadership]
    [leadership]
        id=leadership
        value=25
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define WEAPON_SPECIAL_WBPRECISION
	[chance_to_hit]
		id=precision
		name= _ "precision"
		description= _ "This attack has an 80% chance to hit when used on offensively."
		value=80
		cumulative=no
            active_on=offense
	[/chance_to_hit]
#enddef


#define ABILITY_SANDVEIL
    [hides]
        id=sandveil
        name= _ "sandveil"
        female_name= _ "female^sandveil"
        name_inactive= _ "sandveil"
        female_name_inactive= _ "female^sandveil"
        description= _ "This unit can hide in deserts, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in a desert, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        description_inactive= _ "Sandveil:
This unit can hide in deserts, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in a desert, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        affect_self=yes
        [filter_self]
            [filter_location]
                terrain=Dd^Dc,Dd,Ds,Hd
            [/filter_location]
        [/filter_self]
    [/hides]
#enddef

#define ABILITY_SNOWCLOAK
    [hides]
        id=snowcloak
        name= _ "snowcloak"
        female_name= _ "female^snowcloak"
        name_inactive= _ "snowcloak"
        female_name_inactive= _ "female^snowcloak"
        description= _ "This unit can hide in the snow, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in the snow, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        description_inactive= _ "Snowcloak:
This unit can hide in the snow, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in the snow, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        affect_self=yes
        [filter_self]
            [filter_location]
                terrain=Aa,Aa^Fpa,Aa^Fda,Aa^Fma,Ha^Fpa,Ha^Fda,Ha^Fma,Ha
            [/filter_location]
        [/filter_self]
    [/hides]
#enddef


#define ABILITY_DROWN
    [resistance]
        id=drowns
        add=-20
        max_value=60
        apply_to=blade,pierce,impact
        name= _ "drowns"
        description= _ "Drowns:
Adjacent units of an enemy side in water are grappled by this unit, which tries to drown them. This causes those units to receive a -20% to their physical resistances. This has no effect on non-living units (i.e. Undead, Mechanical, Toys)."
        affect_self=no
	  affect_allies=no
	  affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
		[filter]
			[filter_location]
                terrain=Chw,Chs,Wwf,Ww^Vm,Chw^Bw|,Chs^Bw|,Khw^Bw|,Khs^Bw|,Chw^Bw/Chs^Bw/,Khw^Bw/,Khs^Bw/,Khw,Khs,Ss^Vhs,Ss^Vm,Chw^Bw\,Chs^Bw\,Khw^Bw\,Khs^Bw\,Ww,Wo,Ss,Wwr,Ww^Bw\,Wo^Bw\,Ss^Bw\,Wwr^Bw\,Ww^Bw/,Wo^Bw/,Ss^Bw/,Wwr^Bw/,Ww^Bw|,Wo^Bw|,Ss^Bw|,Wwr^Bw|
                  [/filter_location]
		[not]
			[filter_wml]
				[status]
					not_living=yes
				[/status]
			[/filter_wml]
		[/not]
		[/filter]
        [/affect_adjacent]
    [/resistance]
#enddef

#define WEAPON_SPECIAL_WBKILLSHOT
	[chance_to_hit]
		id=Killshot
		name= _ "Killshot"
		description= _ "Killshot:
This attack will always hit."
		value=1
		cumulative=no
            active_on=both
	[/chance_to_hit]
#enddef

#define ABILITY_WB_RALLY_LEVEL_1
    [leadership]
        id=rally
        value=15
        cumulative=yes
        name= _ "rally"
	female_name= _ "rally"
	name_inactive= _ "rally"
	female_name_inactive= _ "rally"
        description= _ "After making an attack, this unit can rally friendly units that are next to it, making them fight (15% times this unit's level) better, regardless of their level.

This effect stacks on top of other leadership abilities."

        affect_self=no
        [filter]
            [filter_wml]
                attacks_left=0
            [/filter_wml]
        [/filter]
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/leadership]
#enddef
#define ABILITY_WB_RALLY_LEVEL_2
    [leadership]
        id=rally
        value=30
        cumulative=yes
        name= _ "rally"
	female_name= _ "rally"
	name_inactive= _ "rally"
	female_name_inactive= _ "rally"
        description= _ "After making an attack, this unit can rally friendly units that are next to it, making them fight (15% times this unit's level) better, reguardless of their level.

This effect stacks on top of other leadership abilities."

        affect_self=no
        [filter]
            [filter_wml]
                attacks_left=0
            [/filter_wml]
        [/filter]
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/leadership]
#enddef
#define ABILITY_WB_RALLY_LEVEL_3
    [leadership]
        id=rally
        value=45
        cumulative=yes
        name= _ "rally"
	female_name= _ "rally"
	name_inactive= _ "rally"
	female_name_inactive= _ "rally"
        description= _ "After making an attack, this unit can rally friendly units that are next to it, making them fight (15% times this unit's level) better, reguardless of their level.

This effect stacks on top of other leadership abilities."

        affect_self=no
        [filter]
            [filter_wml]
                attacks_left=0
            [/filter_wml]
        [/filter]
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/leadership]
#enddef

#define ABILITY_WB_DISTRACT
    [skirmisher]
        id=distract
        name= _ "distract"
        description= _ "This unit negates enemy Zones of Control around itself for allied units (but not for itself)."
        affect_self=no
        affect_allies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/skirmisher]
#enddef


#define ABILITY_SNEAKING
    # Canned definition of the Sneaking ability to be included in an
    # [abilities] clause.
    [hides]
        id=sneaking
        name= _ "sneaking"
        female_name= _ "female^sneaking"
        name_inactive= _ "sneaking"
        female_name_inactive= _ "female^sneaking"
        description= _ "Sneaking:
This unit can hide in hills, and remain undetected by its enemies.

Enemy units cannot see this unit while it is on hills, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        description_inactive= _ "Sneaking:
This unit can hide in hills, and remain undetected by its enemies.

Enemy units cannot see this unit while it is on hills, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        affect_self=yes
        alert=_"Someone is sneaking on you...!"
        [filter_self]
            [filter_location]
                terrain=*^Dr,Hh^*,Hhd^*,Hd^*,Ha^*,Uh^*
            [/filter_location]
        [/filter_self]
    [/hides]
#enddef


#define SUMMON_FUNGUS
    [set_menu_item]
        id=summon_fungus
        description=_ "Summon fungus for 9 gold"
        [show_if]
        [/show_if]

        [filter_location]
            [filter_adjacent_location]
                [filter]
                    type=biovore
                    side=$side_number
                    [filter_wml]
                        moves=$this_unit.max_moves
                    [/filter_wml]
                    [filter_location]
                        [not]
                            terrain=C*,K*
                        [/not]
                    [/filter_location]
                [/filter]
            [/filter_adjacent_location]
            [not]
                [filter]
                [/filter]
                [or]
                    terrain=_off^_usr,Q*,W*,*^X*,X*,*^V*
                [/or]
            [/not]
        [/filter_location]
        [command]
            [store_gold]
                variable=actualgold
                side=$side_number
            [/store_gold]
            {IF_VAR actualgold greater_than_equal_to 9 (
                [then]
                    [gold]
                        amount=-9
                        side=$side_number
                    [/gold]
                    [unit]
                        type=fungus
                        side=$side_number
                        x,y=$x1,$y1
                        moves=0
                        animate=yes
                    [/unit]
                    {MODIFY_UNIT x,y=$x1,$y1 attacks_left 0}
                    {MODIFY_UNIT x,y=$x1,$y1 moves 0}
                    [store_unit]
                        [filter]
                            type=biovore
                            side=$side_number
                            [filter_wml]
                                moves=$this_unit.max_moves
                            [/filter_wml]
                            [filter_adjacent]
                                x,y=$x1,$y1
                            [/filter_adjacent]
                        [/filter]
                        variable=able_to_summon
                    [/store_unit]
                    {IF_VAR able_to_summon.length greater_than 1 (
                        [then]
                            {FOREACH able_to_summon a}
                                {IF_VAR able_to_summon[$a].id equals $last_selected_unit.id (
                                    [then]
                                        {VARIABLE able_to_summon[$a].attacks_left 0}
                                        {VARIABLE able_to_summon[$a].moves 0}
                                        {VARIABLE_OP able_to_summon[$a].experience add 3}

                                        [unstore_unit]
                                            variable=able_to_summon[$a]
                                            find_vacant=no
                                            text= _ "+3 exp"
                                            red,green,blue=50,50,200
                                        [/unstore_unit]
                                        {CLEAR_VARIABLE able_to_summon}
                                    [/then]
                                    [else]
                                        [filter_condition]
                                            [variable]
                                                name=last_selected_unit.id
                                                equals=$empty
                                            [/variable]
                                            [or]
                                                [have_unit]
                                                    id=$last_selected_unit.id
                                                    [not]
                                                        [filter_adjacent]
                                                            x,y=$x1,$y1
                                                        [/filter_adjacent]
                                                    [/not]
                                                [/have_unit]
                                            [/or]
                                        [/filter_condition]

                                        [store_unit]
                                            [filter]
                                                id=able_to_summon[$a].id
                                            [/filter]
                                            variable=last_selected_unit
                                        [/store_unit]
                                        {VARIABLE able_to_summon[$a].attacks_left 0}
                                        {VARIABLE able_to_summon[$a].moves 0}
                                        {VARIABLE_OP able_to_summon[$a].experience add 3}

                                        [unstore_unit]
                                            variable=able_to_summon[$a]
                                            find_vacant=no
                                            text= _ "+3 exp"
                                            red,green,blue=50,50,200
                                        [/unstore_unit]
                                        {CLEAR_VARIABLE able_to_summon}
                                        {CLEAR_VARIABLE summoners}
                                    [/else]
                                )}
                            {NEXT a}
                        [/then]
                        [else]
                            [store_unit]
                                variable=able_to_summon
                                [filter]
                                    type=biovore
                                    side=$side_number
                                    [filter_wml]
                                        moves=$this_unit.max_moves
                                    [/filter_wml]
                                    [filter_adjacent]
                                        x,y=$x1,$y1
                                    [/filter_adjacent]
                                [/filter]
                            [/store_unit]
                            {VARIABLE able_to_summon.attacks_left 0}
                            {VARIABLE able_to_summon.moves 0}
                            {VARIABLE_OP able_to_summon.experience add 3}

                            [unstore_unit]
                                variable=able_to_summon
                                find_vacant=no
                                text= _ "+3 exp"
                                red,green,blue=50,50,200
                            [/unstore_unit]
                            {CLEAR_VARIABLE able_to_summon}
                            [fire_event]
                                name=post summon
                                [primary_unit]
                                    x,y=$x1,$y1
                                [/primary_unit]
                            [/fire_event]
                        [/else]
                    )}
                [/then]
                [else]
                    [message]
                        speaker=narrator
                        side_for=$side_number
                        caption=_ "Error"
                        message= _ "I have insufficient materials. I am unable to summon."
                        image=wesnoth-icon.png
                    [/message]
                [/else]
            )}
            {CLEAR_VARIABLE actualgold}
        [/command]
    [/set_menu_item]

    [set_menu_item]
        id=summon_zhelp
        description= _ "Summoning Help"
        image=items/book2.png~CROP(21,23,27,24)~SCALE(20,20)
        [show_if]
        [/show_if]

        [filter_location]
            [filter]
                ability=oe_summon
                side=$side_number
            [/filter]
        [/filter_location]
        [command]
            [message]
                speaker=narrator
                side_for=$side_number
                caption=_ "Help"
                message= _ "To summon a unit right-click on hexes adjacent to a selected summoner.

You need all movement points (and remaining attacks) to summon one creature. You are unable to summon in villages, from castles or keeps. A new unit cant be summoned on water.
Every summoning adds +3 to current experience.

If there are 2 or more summoners, a new unit will be summoned by the last selected unit able to summon, or if no summoner has been selected, a summoner next to the selected tile will be chosen randomly."
                image=wesnoth-icon.png
            [/message]
        [/command]
    [/set_menu_item]
#enddef